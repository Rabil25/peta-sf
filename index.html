<!DOCTYPE html>
<html>
<head>
  <title>Peta Lokasi SF (Absen & Deal)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans&display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
      font-size: 13px;
    }
    #map {
      height: 100vh;
      width: 100vw;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 0;
    }
    #logo {
      position: absolute;
      top: 10px;
      right: 125px;
      width: 120px;
      z-index: 1002;
    }
    #sidebar-left, #sidebar-right {
      position: absolute;
      top: 50px;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1001;
      font-size: 12px;
      max-height: 75vh;
      overflow-y: auto;
      display: none;
    }
    #sidebar-left { left: 10px; width: 260px; }
    #sidebar-right { right: 10px; width: 200px; }
    .toggle-btn {
      position: absolute;
      padding: 5px 10px;
      font-size: 12px;
      background: white;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      cursor: pointer;
      z-index: 1003;
    }
    #btn-left { left: 10px; top: 10px; }
    #btn-right { right: 10px; top: 60px; }
    #notAbsentListWrapper { margin-top: 10px; }
    #notAbsentList li { list-style: none; margin-bottom: 3px; }
    #tanggal-hari-ini {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 5px 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 12px;
      z-index: 1000;
    }
    .sf-tooltip {
      font-size: 11px;
      background: rgba(255, 255, 255, 0.8);
      padding: 2px 6px;
      border-radius: 8px;
      color: #000;
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
  <img src="logo_indiHome.png" id="logo" alt="IndiHome" />
  <div id="map"></div>
  <div class="toggle-btn" id="btn-left">ðŸ‘¤ Cek POS</div>
  <div class="toggle-btn" id="btn-right">ðŸ“Š Deal</div>
  <div id="sidebar-left">
    <h3>Cek POS</h3>
    <div id="absenStats">Loading...</div>
    <div id="notAbsentListWrapper">
      <ul id="notAbsentList">Loading...</ul>
    </div>
  </div>
  <div id="sidebar-right">
    <h3>Total Deal Hari Ini</h3>
    <div id="totalDeal">Loading...</div>
  </div>
  <div id="tanggal-hari-ini"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    document.getElementById("tanggal-hari-ini").textContent =
      `Hari Ini: ${new Date().toLocaleDateString('id-ID', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      })}`;

    const absenCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwTyrQDZdI7VZquGlA2ilcpTtv2DAmTzQYqKml8jHqWqhUg5AdYIyvqkU2-QKmU6EKXsuT1wpr3rHT/pub?gid=1291668973&single=true&output=csv';
    const userdataCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwTyrQDZdI7VZquGlA2ilcpTtv2DAmTzQYqKml8jHqWqhUg5AdYIyvqkU2-QKmU6EKXsuT1wpr3rHT/pub?gid=1651680381&single=true&output=csv';
    const bulanIniCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwTyrQDZdI7VZquGlA2ilcpTtv2DAmTzQYqKml8jHqWqhUg5AdYIyvqkU2-QKmU6EKXsuT1wpr3rHT/pub?gid=1666449039&single=true&output=csv';

    const map = L.map('map').setView([-2.13456, 106.13456], 10);
    const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' });
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles Â© Esri' });
    const esriLabels = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { attribution: 'Labels Â© Esri' });
    const hybrid = L.layerGroup([esriSat, esriLabels]);
    const baseMaps = { "Peta Jalan": osm, "Citra Satelit + Label": hybrid };
    hybrid.addTo(map);
    L.control.layers(baseMaps).addTo(map);

    let telegramToCodeSF = {}, telegramToName = {}, telegramToRole = {};
    let codeSFWithIO = new Set(), allSFNames = new Set(), absenSFNames = new Set();

    function capitalizeWords(str) {
      return str.replace(/\b\w/g, l => l.toUpperCase());
    }

    function loadUserdata(cb) {
      Papa.parse(userdataCSV, {
        download: true,
        complete: (result) => {
          result.data.forEach(row => {
            if (!row || row.length < 8) return;
            const id = row[7];
            const code = row[5];
            const nama = capitalizeWords(row[2] || '');
            const role = (row[4] || '').toLowerCase();
            if (id) {
              if (code) telegramToCodeSF[id] = code;
              if (nama) telegramToName[id] = nama;
              if (role) telegramToRole[id] = role;
              if (role === 'sf') allSFNames.add(nama);
            }
          });
          cb();
        }
      });
    }

    function loadBulanIni(cb) {
      let totalToday = 0;
      const todayStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
      Papa.parse(bulanIniCSV, {
        download: true,
        complete: (result) => {
          result.data.forEach(row => {
            if (!row || row.length < 85) return;
            const code = row[83];
            const validIO = row[73];
            const tanggal = row[74];
            if (validIO && tanggal === todayStr && code) {
              codeSFWithIO.add(code);
              totalToday++;
            }
          });
          document.getElementById("totalDeal").textContent = `Total Deal Hari Ini: ${totalToday}`;
          cb();
        }
      });
    }

    function loadAbsen() {
      Papa.parse(absenCSV, {
        download: true,
        header: true,
        complete: (result) => {
          result.data.forEach(row => {
            if (!row) return;
            const waktu = row['Timestamp'] || row[0];
            const idTelegram = String(row['User ID']).trim();
            const lat = parseFloat(row['Latitude']);
            const lng = parseFloat(row['Longitude']);
            if (!waktu || !isToday(waktu)) return;
            const code = telegramToCodeSF[idTelegram];
            const nama = telegramToName[idTelegram];
            const role = telegramToRole[idTelegram];
            if (!code || !nama || !role || role !== 'sf' || isNaN(lat) || isNaN(lng)) return;
            absenSFNames.add(nama);
            const hasIO = codeSFWithIO.has(code);
            const warna = hasIO ? '#4CAF50' : '#2196F3';
            const icon = L.circleMarker([lat, lng], {
              radius: 8,
              color: warna,
              fillColor: warna,
              fillOpacity: 0.9,
              weight: 2
            }).addTo(map);
            icon.bindTooltip(`<div class="sf-tooltip">${nama}</div>`, {
              permanent: true,
              direction: 'top',
              opacity: 1
            }).openTooltip();
          });

          const notAbsentList = document.getElementById("notAbsentList");
          notAbsentList.innerHTML = '';
          const belumAbsen = Array.from(allSFNames).filter(nama => !absenSFNames.has(nama));
          belumAbsen.forEach(nama => {
            const li = document.createElement("li");
            li.textContent = `â€¢ ${nama}`;
            notAbsentList.appendChild(li);
          });

          document.getElementById("absenStats").innerHTML = `
            âœ… SF Absen: ${absenSFNames.size}<br>
            âŒ SF Belum Absen: ${belumAbsen.length}`;
        }
      });
    }

    function isToday(str) {
      if (!str || typeof str !== 'string') return false;
      const parts = str.split(' ')[0].split('-');
      if (parts.length !== 3) return false;
      const [year, month, day] = parts.map(Number);
      const now = new Date();
      return (
        now.getFullYear() === year &&
        now.getMonth() + 1 === month &&
        now.getDate() === day
      );
    }

    document.getElementById("btn-left").addEventListener("click", () => {
      const panel = document.getElementById("sidebar-left");
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });

    document.getElementById("btn-right").addEventListener("click", () => {
      const panel = document.getElementById("sidebar-right");
      panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    });

    loadUserdata(() => {
      loadBulanIni(() => {
        loadAbsen();
      });
    });

    setTimeout(() => location.reload(), 300000); // auto refresh 5 menit
  </script>
</body>
</html>
