<!DOCTYPE html>
<html>
<head>
  <title>Peta Lokasi SF (Absen & Deal)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100%; }
    #sidebar-left, #sidebar-right {
      position: absolute;
      top: 10px;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 1000;
      font-family: sans-serif;
      font-size: 14px;
      max-height: 90vh;
      overflow-y: auto;
    }
    #sidebar-left { left: 10px; width: 250px; }
    #sidebar-right { right: 10px; }
    #sidebar-left h3, #sidebar-right h3 {
      margin: 0 0 5px 0;
      color: #d00;
    }
    #notAbsentListWrapper {
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 5px;
      max-height: 250px;
      overflow-y: auto;
    }
    #notAbsentList li {
      list-style: none;
      margin-bottom: 3px;
    }
    #tanggal-hari-ini {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 6px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-family: sans-serif;
      font-size: 14px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar-left">
    <h3>Cek POS</h3>
    <div id="absenStats">Loading...</div>
    <div id="notAbsentListWrapper">
      <ul id="notAbsentList">Loading...</ul>
    </div>
  </div>
  <div id="sidebar-right">
    <h3>Total Deal Hari Ini</h3>
    <div id="totalDeal">Loading...</div>
  </div>
  <div id="tanggal-hari-ini"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const map = L.map('map').setView([-2.13456, 106.13456], 10);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles © Esri'
    }).addTo(map);

    const absenCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwTyrQDZdI7VZquGlA2ilcpTtv2DAmTzQYqKml8jHqWqhUg5AdYIyvqkU2-QKmU6EKXsuT1wpr3rHT/pub?gid=1291668973&single=true&output=csv';
    const userdataCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwTyrQDZdI7VZquGlA2ilcpTtv2DAmTzQYqKml8jHqWqhUg5AdYIyvqkU2-QKmU6EKXsuT1wpr3rHT/pub?gid=1651680381&single=true&output=csv';
    const bulanIniCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRwTyrQDZdI7VZquGlA2ilcpTtv2DAmTzQYqKml8jHqWqhUg5AdYIyvqkU2-QKmU6EKXsuT1wpr3rHT/pub?gid=1666449039&single=true&output=csv';

    const now = new Date();
    const todayStr = now.getFullYear().toString() +
                     String(now.getMonth() + 1).padStart(2, '0') +
                     String(now.getDate()).padStart(2, '0');

    let telegramToCodeSF = {};
    let telegramToName = {};
    let telegramToRole = {};
    let codeSFWithIO = new Set();
    let allSFNames = new Set();
    let absenSFNames = new Set();

    function capitalizeWords(str) {
      return str.replace(/\b\w/g, l => l.toUpperCase());
    }

    function loadUserdata(cb) {
      Papa.parse(userdataCSV, {
        download: true,
        complete: (result) => {
          result.data.forEach(row => {
            if (!row || row.length < 8) return;
            const id = row[7];
            const code = row[5];
            const nama = capitalizeWords(row[2] || '');
            const role = (row[4] || '').toLowerCase();
            if (id) {
              if (code) telegramToCodeSF[id] = code;
              if (nama) telegramToName[id] = nama;
              if (role) telegramToRole[id] = role;
              if (role === 'sf') allSFNames.add(nama);
            }
          });
          cb();
        }
      });
    }

    function loadBulanIni(cb) {
      let totalToday = 0;
      Papa.parse(bulanIniCSV, {
        download: true,
        complete: (result) => {
          result.data.forEach(row => {
            if (!row || row.length < 85) return;
            const code = row[83];
            const validIO = row[73];
            const tanggal = row[74];
            if (validIO && tanggal === todayStr && code) {
              codeSFWithIO.add(code);
              totalToday++;
            }
          });
          document.getElementById("totalDeal").textContent = `Total Deal Hari Ini: ${totalToday}`;
          cb();
        }
      });
    }

    function loadAbsen() {
      Papa.parse(absenCSV, {
        download: true,
        header: true,
        complete: (result) => {
          result.data.forEach(row => {
            if (!row) return;
            const waktu = row['Timestamp'] || row[0];
            const idTelegram = String(row['User ID']).trim();
            const lat = parseFloat(row['Latitude']);
            const lng = parseFloat(row['Longitude']);
            if (!waktu || !isToday(waktu)) return;

            const code = telegramToCodeSF[idTelegram];
            const nama = telegramToName[idTelegram];
            const role = telegramToRole[idTelegram];
            if (!code || !nama || !role || role !== 'sf' || isNaN(lat) || isNaN(lng)) return;

            absenSFNames.add(nama);

            const hasIO = codeSFWithIO.has(code);
            const warna = hasIO ? 'green' : 'blue';

            const icon = L.marker([lat, lng], {
              icon: L.icon({
                iconUrl: `https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|${warna}`,
                iconSize: [21, 34],
                iconAnchor: [10, 34],
                popupAnchor: [0, -34]
              })
            }).addTo(map);

            icon.bindTooltip(nama, { permanent: true, direction: 'top' }).openTooltip();
          });

          const notAbsentList = document.getElementById("notAbsentList");
          notAbsentList.innerHTML = '';
          const belumAbsen = Array.from(allSFNames).filter(nama => !absenSFNames.has(nama));
          belumAbsen.forEach(nama => {
            const li = document.createElement("li");
            li.textContent = `• ${nama}`;
            notAbsentList.appendChild(li);
          });

          document.getElementById("absenStats").innerHTML = `
            ✅ SF Absen: ${absenSFNames.size}<br>
            ❌ SF Belum Absen: ${belumAbsen.length}
          `;
        }
      });
    }

    function isToday(str) {
      if (!str || typeof str !== 'string') return false;
      const parts = str.split(' ')[0].split('-');
      if (parts.length !== 3) return false;
      const [year, month, day] = parts.map(Number);
      const now = new Date();
      return (
        now.getFullYear() === year &&
        now.getMonth() + 1 === month &&
        now.getDate() === day
      );
    }

    loadUserdata(() => {
      loadBulanIni(() => {
        loadAbsen();
      });
    });

    setTimeout(() => location.reload(), 300000); // 5 menit

    // Tampilkan tanggal lokal hari ini
    document.getElementById("tanggal-hari-ini").textContent =
      `Hari Ini: ${now.toLocaleDateString('id-ID', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      })}`;
  </script>
</body>
</html>
